#!/usr/bin/env bash
set -euo pipefail

die() {
  echo "error: $*" >&2
  exit 1
}

usage() {
  cat <<'EOF'
Rebuild @openai/codex with a small TUI patch to re-enable the hidden
"Pair Programming" + "Execute" collaboration modes, then replace the global
npm vendor binary.

macOS only. Tested with @openai/codex 0.94.0.

Usage:
  ./bin/codex-repatch-modes [--version <x.y.z[-alpha.n]>]

Notes:
  - If --version is omitted, the version is read from `codex --version`.
  - This script overwrites the vendor binary inside your global npm install of
    @openai/codex, but makes an on-disk backup first.
EOF
}

VERSION=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    --version)
      VERSION="${2:-}"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      die "unknown argument: $1"
      ;;
  esac
done

os="$(uname -s)"
[[ "$os" == "Darwin" ]] || die "macOS only (got: $os)"

command -v git >/dev/null 2>&1 || die "missing dependency: git"
command -v cargo >/dev/null 2>&1 || die "missing dependency: cargo (Rust toolchain)"
command -v node >/dev/null 2>&1 || die "missing dependency: node (Node.js)"
command -v npm >/dev/null 2>&1 || die "missing dependency: npm (Node.js)"

if [[ -z "$VERSION" ]]; then
  command -v codex >/dev/null 2>&1 || die "codex not found; pass --version to build a specific tag"
  VERSION="$(codex --version | awk '{print $2}')"
fi

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd -- "$SCRIPT_DIR/.." && pwd)"
PATCH_FILE="${CODEX_PATCH_FILE:-$REPO_ROOT/patches/openai-codex-enable-execute-pair-tui.patch}"
BUILD_DIR="${CODEX_PATCH_BUILD_DIR:-$HOME/.codex/patch-build/openai-codex}"

[[ -f "$PATCH_FILE" ]] || die "patch file not found: $PATCH_FILE"

TAG="rust-v$VERSION"

mkdir -p "$(dirname "$BUILD_DIR")"
if [[ ! -d "$BUILD_DIR/.git" ]]; then
  git clone "https://github.com/openai/codex.git" "$BUILD_DIR"
fi

cd "$BUILD_DIR"
git fetch --tags --force --prune origin
git checkout -f "$TAG" || die "tag not found: $TAG"
git reset --hard

git apply "$PATCH_FILE"

cd codex-rs
if command -v just >/dev/null 2>&1; then
  just fmt
else
  cargo fmt
fi
cargo build --release -p codex-cli --bin codex

PATCHED_BIN="$BUILD_DIR/codex-rs/target/release/codex"
[[ -x "$PATCHED_BIN" ]] || die "build output missing: $PATCHED_BIN"

arch="$(uname -m)"
case "$arch" in
  arm64|aarch64) target="aarch64-apple-darwin" ;;
  x86_64|amd64) target="x86_64-apple-darwin" ;;
  *) die "unsupported macOS arch: $arch" ;;
esac

VENDOR_BIN=""

# Prefer resolving the vendor path from the currently active `codex` shim so we don't
# accidentally use a different global npm root (e.g. Homebrew npm vs fnm npm).
if command -v codex >/dev/null 2>&1; then
  codex_shim="$(command -v codex)"
  codex_js_real="$(node -e 'console.log(require("fs").realpathSync(process.argv[1]))' "$codex_shim" 2>/dev/null || true)"
  if [[ -n "$codex_js_real" ]]; then
    codex_pkg_root="$(cd -- "$(dirname -- "$codex_js_real")/.." && pwd)"
    candidate="$codex_pkg_root/vendor/$target/codex/codex"
    if [[ -f "$candidate" ]]; then
      VENDOR_BIN="$candidate"
    fi
  fi
fi

if [[ -z "$VENDOR_BIN" ]]; then
  NPM_ROOT="$(npm root -g)"
  [[ -d "$NPM_ROOT" ]] || die "npm root not found: $NPM_ROOT"
  VENDOR_BIN="$NPM_ROOT/@openai/codex/vendor/$target/codex/codex"
fi

[[ -f "$VENDOR_BIN" ]] || die "vendor binary not found: $VENDOR_BIN"

ts="$(date +%Y%m%d-%H%M%S)"
backup="$VENDOR_BIN.orig-$ts"
tmp="$VENDOR_BIN.new-$ts"
failed="$VENDOR_BIN.failed-$ts"

# Prepare replacement as a new file in the same directory, then atomically move it into place.
# Avoid in-place overwrites (e.g. `cp patched vendor_bin`) which can get SIGKILL'd on macOS.
cp -a "$PATCHED_BIN" "$tmp"
chmod +x "$tmp"

# Backup existing vendor binary by renaming (atomic, preserves original file as-is).
mv "$VENDOR_BIN" "$backup"
mv "$tmp" "$VENDOR_BIN"

# Sanity check; rollback on failure.
set +e
version_out="$("$VENDOR_BIN" --version 2>&1)"
code=$?
set -e
if [[ $code -ne 0 || -z "$version_out" ]]; then
  echo "error: patched vendor binary failed to run; rolling back" >&2
  mv -f "$VENDOR_BIN" "$failed" 2>/dev/null || true
  mv -f "$backup" "$VENDOR_BIN"
  exit 1
fi

echo "ok: installed patched codex binary"
echo "  version: $VERSION ($TAG)"
echo "  vendor:  $VENDOR_BIN"
echo "  backup:  $backup"
